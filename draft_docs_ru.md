
# Назначение функций `gks.R`    

Функции предназначены для чтения таблиц из сборников "Регионы России" с сайта Росстат [gks.ru](http://www.gks.ru/wps/wcm/connect/rosstat_main/rosstat/ru/statistics/publications/catalog/doc_1138623506156). Для навигации по содержанию (годы, наименования показателей) используется API сайта Росстата. Таблицы разных лет выложены в трёх различных форматах:    

* веб-страницы -- загружаются во временный файл, парсинг таблиц реализован с помощью пакетов `RCurl`, `XML`, `xml2`;     

* .docx-файлы -- загружаются во временный файл, формат файла позволяет разбирать его как XML-документ;      

* .doc-файлы -- парсинг пока не реализован.    

Как правило, каждая таблица содержится в отдельном файле. На этапе разбора возникает ряд сложностей:    

1. Сложные заголовки с объединёнными ячейками. Проблема решена для html-страниц.    

1. Символы мягкого переноса в docx и doc-файлах, которые превращяются в разрыв ячейки.      

1. Изменяющиеся символы пропущенных значений (`...`, `-`, пусто), запятые как разделители целой и дробной части. Проблема решается на этапе очистки заменой символов.    

1. Изменяющиеся метки регионов. Изменение административно-территориального деления здесь играет меньгую роль, чем ведущие и хвостовые проблемы. Это предполагается решить с помощью ключевой таблицы с кодами ОКАТО в качестве уникальных идентификаторов регионов.    

1. Наличие сносок прямо в таблицах данных на примечания в последней (объединённой) строке таблицы. Сноски начинаются с открывающей скобки `(`, и, к счастью, есть спобоб их отловить -- теги <SUP>.       


# Описание основных функций `gks.R`    

# ..............................................................................
`getGKSDataRef()`
# ..............................................................................

## Выбрать год, показатель и загрузить данные    

### Описание
Загружает со страницы сборников "Регионв России" список ссылок на сборники по годам, читает оглавление справочника и показывает диалог в консоли, чтобы пользователь мог выбрать нужный показатель. Функция определяет тип документа, в котором находится нужный показатель (html, doc, docx) и вызывает соответствующую функцию-парсер. В итоге таблица загружается в пространство имён.           

### Использование    

`getGKSDataRef()`   

### Аргументы    

Отсутствуют.   

### Возвращаемое значение    

Список с элементами:     

* `$URL` -- ссылка на таблицу-источник из сборника "Регионы России".     

* `$download_time` -- время загрузки статистики.     

* `$data` -- фрейм со статистикой.   

* `$footnote_positions` -- фрейм, описывающий расположение сносок в таблице данных. Содержит три столбца: метка ссылки, строка и столбец ячейки, к которой эта ссылка стоит.    

* `$footnote_legend` -- фрейм с расшифровкой сносок. Два столбца: метка ссылки и её текст.   


# ..............................................................................
`getTableFromHtm()`
# ..............................................................................

## Загрузить таблицу в R с html (htm)-страницы    

### Описание    

Загружает страницу с указанного адреса и разбирает таблицу со статистикой. Результат возвращается в виде списка, один из элементов которого -- фрейм с данными таблицы.       

### Использование    

`getTableFromHtm(ref)`

### Аргументы    

`ref` -- URL веб-страницы, с которой загружаются данные.     

### Подробности    

При разборе таблицы высота заголовка определяется по наличию атрибута `colspan`, либо заголовком считается первая строка. Первый столбец считается столбцом меток.   

### Возвращаемое значение    

Список с элементами:     

* `$URL` -- ссылка на таблицу-источник из сборника "Регионы России".     

* `$download_time` -- время загрузки статистики.     

* `$data` -- фрейм со статистикой.   

* `$footnote_positions` -- фрейм, описывающий расположение сносок в таблице данных. Содержит три столбца: метка ссылки, строка и столбец ячейки, к которой эта ссылка стоит.    

* `$footnote_legend` -- фрейм с расшифровкой сносок. Два столбца: метка ссылки и её текст.   

# Описание вспомогательных функций `gks.ru`    

## 

